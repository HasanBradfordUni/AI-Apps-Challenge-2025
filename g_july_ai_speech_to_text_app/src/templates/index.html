<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Has AI - AI Speech-to-Text App</title>
    <link rel="icon" href="https://i.postimg.cc/PqP5VwNZ/Has-AI-logo.png" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/hasAi.css') }}" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        background-color: black;
        text-align: center;
        color: white;
        font-family: Arial, sans-serif;
        padding-top: 20px !important; /* Reduced from implied spacing */
      }

      header {
        position: fixed;
        top: 0;
        width: 100%;
        background-color: goldenrod;
        z-index: 1000;
        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        transform: translateY(-100%);
        opacity: 0;
      }

      header.header-hover {
        transform: translateY(0);
        opacity: 1;
      }

      /* Header hover zone - invisible area at top of screen */
      .header-hover-zone {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 50px;
        z-index: 999;
        background: transparent;
        pointer-events: auto;
      }

      .mainBody {
        margin-top: 20px; /* Reduced from 150px */
        padding: 20px;
      }

      .mainHeading {
        color: crimson;
        font-size: xx-large;
        margin-bottom: 20px;
      }

      .subHeading {
        color: rebeccapurple;
        font-size: larger;
        margin-bottom: 30px;
      }

      .section {
        background-color: #1a1a1a;
        margin: 20px auto;
        padding: 20px;
        border-radius: 10px;
        max-width: 800px;
        border: 2px solid #333;
        scroll-margin-top: 70px; /* Account for header when visible */
      }

      .section h3 {
        color: goldenrod;
        margin-bottom: 15px;
      }

      .button {
        background-color: #35424a;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        border-radius: 5px;
        margin: 5px;
        font-size: 16px;
      }

      .button:hover {
        background-color: #45a049;
      }

      .button:disabled {
        background-color: #666;
        cursor: not-allowed;
      }

      .recording-button {
        background-color: #dc3545;
        font-size: 18px;
        padding: 15px 30px;
      }

      .recording-button.recording {
        background-color: #28a745;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
      }

      .form-group {
        margin: 15px 0;
        text-align: left;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: goldenrod;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #666;
        border-radius: 4px;
        background-color: #2a2a2a;
        color: white;
      }

      .transcript-display {
        background-color: #2a2a2a;
        padding: 20px;
        border-radius: 5px;
        margin: 15px 0;
        border: 1px solid #666;
        min-height: 150px;
        text-align: left;
        max-height: 300px;
        overflow-y: auto;
      }

      .ai-summary {
        background-color: #1a3a1a;
        padding: 20px;
        border-radius: 5px;
        margin: 15px 0;
        border: 1px solid #4a7c59;
        text-align: left;
      }

      .voice-training {
        background-color: #3a1a1a;
        padding: 20px;
        border-radius: 5px;
        margin: 15px auto;
        border: 1px solid #7c4a59;
      }

      .sessions-list {
        background-color: #2a2a2a;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
        max-height: 200px;
        overflow-y: auto;
      }

      .session-item {
        background-color: #1a1a1a;
        padding: 10px;
        margin: 5px 0;
        border-radius: 3px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 10px;
      }

      .status-recording {
        background-color: #dc3545;
        animation: pulse 1s infinite;
      }

      .status-ready {
        background-color: #28a745;
      }

      .status-processing {
        background-color: #ffc107;
      }

      .logo {
        border-style: solid;
        border-color: white;
        vertical-align: middle;
        margin: 0 20px;
      }

      footer {
        margin-top: 50px;
        padding: 20px;
        background-color: goldenrod;
        color: black;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background-color: #666;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }

      .progress-fill {
        height: 100%;
        background-color: #4CAF50;
        transition: width 0.3s ease;
      }

      @media (max-width: 768px) {
        body {
          padding-top: 20px !important;
        }
        
        .section {
          margin: 10px;
          padding: 15px;
          scroll-margin-top: 70px;
        }
      }

      @media (max-width: 480px) {
        body {
          padding-top: 20px !important;
        }
        
        .section {
          scroll-margin-top: 70px;
        }
      }

      /* Toggle Switch Styles */
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
      }

      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        border-radius: 50%;
        transition: .4s;
      }

      input:checked + .toggle-slider {
        background-color: #2196F3;
      }

      input:checked + .toggle-slider:before {
        transform: translateX(26px);
      }

      /* Listening Indicator */
      .listening-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #4CAF50;
        animation: pulse 1.5s infinite;
        margin-right: 10px;
      }

      @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
      }
      
      /* Toggle Switch Styles */
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
      }
    
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
    
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #666;
        transition: 0.4s;
        border-radius: 34px;
      }
    
      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
    
      .toggle-switch input:checked + .toggle-slider {
        background-color: #28a745;
      }
    
      .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(26px);
      }
    
      /* Listening Indicator Animation */
      .listening-indicator {
        width: 15px;
        height: 15px;
        background-color: #90ee90;
        border-radius: 50%;
        animation: pulse-green 1.5s infinite;
      }
    
      @keyframes pulse-green {
        0%, 100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(1.2);
        }
      }
    
      /* Voice Command Notification */
      .voice-notification-show {
        animation: slideDown 0.3s ease-in-out;
      }
    
      .voice-notification-hide {
        animation: slideUp 0.3s ease-in-out;
      }
    
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    
      @keyframes slideUp {
        from {
          opacity: 1;
          transform: translateY(0);
        }
        to {
          opacity: 0;
          transform: translateY(-20px);
        }
      }
    
      /* Command History Styles */
      .command-history-item {
        background-color: #1a1a1a;
        padding: 8px 12px;
        margin: 5px 0;
        border-radius: 5px;
        border-left: 3px solid goldenrod;
        font-size: 14px;
      }
    
      .command-timestamp {
        color: #888;
        font-size: 12px;
        margin-left: 10px;
      }
    
      .command-success {
        border-left-color: #28a745;
      }
    
      .command-error {
        border-left-color: #dc3545;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>
        <img
          src="https://i.postimg.cc/PqP5VwNZ/Has-AI-logo.png"
          alt="The Has AI logo"
          width="50"
          height="50"
          class="logo"
        />
        Has AI
        <img
          src="https://i.postimg.cc/PqP5VwNZ/Has-AI-logo.png"
          alt="The Has AI logo"
          width="50"
          height="50"
          class="logo"
        />
      </h1>
      <hr />
      <div>
        <ul class="nav">
          <li><a href="#recording-section" class="nav">Recording Section</a></li>
          <li><a href="#file-upload-section" class="nav">File Upload Section</a></li>
          <li><a href="#ai-summary-section" class="nav">AI Summary Section</a></li>
          <li><a href="#voice-commands-section" class="nav">Voice Command Section</a></li>
          <li><a href="#voice-training-section" class="nav">Voice Training Section</a></li>
          <li><a href="#export-section" class="nav">Export Section</a></li>
        </ul>
      </div>
    </header>

    <section class="mainBody">
      <h1 class="mainHeading" id="recording-section">AI Speech-to-Text Application</h1>
      <h2 class="subHeading">
        Transform your speech into text with AI-powered transcription, smart summarization, and voice commands. The perfect tool for meetings, lectures, and personal notes.
      </h2>

      <!-- Real-time Recording Section -->
      <div class="section">
        <h3>üé§ Real-time Recording & Transcription</h3>
        <div>
          <span class="status-indicator" id="recording-status"></span>
          <span id="recording-status-text">Ready to record</span>
        </div>
        <div style="margin: 20px 0;">
          <button class="button recording-button" id="record-button" onclick="toggleRecording()">
            Start Recording
          </button>
          <button class="button" onclick="clearTranscript()">Clear Transcript</button>
        </div>
        <div class="transcript-display" id="live-transcript">
          Click "Start Recording" to begin transcription...
        </div>
      </div>

      <!-- File Upload Section -->
      <div class="section" id="file-upload-section">
        <h3>üìÅ Upload Audio File</h3>
        <form method="POST" enctype="multipart/form-data" id="upload-form">
          {{ form.hidden_tag() }}
          <div class="form-group">
            <label for="audio_file">{{ form.audio_file.label }}</label>
            {{ form.audio_file(class="form-control", id="audio_file") }}
            <small>Supported formats: MP3, WAV, M4A, MP4, OGG, FLAC. For best results, use clear audio with minimal background noise.</small>
          </div>
          <div class="form-group">
            <label for="summary_type">{{ form.summary_type.label }}</label>
            {{ form.summary_type(class="form-control", id="summary_type") }}
          </div>
          <div class="form-group">
            <label for="transcription_quality">Transcription Quality:</label>
            <select id="transcription_quality" class="form-control">
              <option value="standard">Standard (Fast)</option>
              <option value="enhanced" selected>Enhanced (Better Quality)</option>
              <option value="chunked">Chunked (For Long Files)</option>
            </select>
          </div>
          <div class="form-group">
            {{ form.submit_file(class="button") }}
          </div>
        </form>
        
        <!-- Transcript Preview Section -->
        <div id="upload-preview" style="display: none;">
          <h4>üìù Transcript Preview</h4>
          <div class="transcript-display" id="upload-transcript-preview">
            Processing uploaded file...
          </div>
          <div id="upload-full-transcript" style="display: none;">
            <button class="button" onclick="showFullTranscript()">Show Full Transcript</button>
          </div>
        </div>
      </div>

      <!-- AI Summary Section -->
      <div class="section" id="ai-summary-section">
        <h3>ü§ñ AI Summary</h3>
        {% if ai_summary %}
        <div class="ai-summary">
          {{ ai_summary|safe }}
        </div>
        {% else %}
        <div class="ai-summary">
          No AI summary available. Upload an audio file or start recording to generate a summary.
        </div>
        {% endif %}
      </div>
      

      <!-- Voice Commands Section -->
      <div class="section" id="voice-commands-section">
        <h3>üéôÔ∏è Voice Assistant</h3>
        <p>Enable voice commands to control the app with your voice - just like Siri or Alexa!</p>
        
        <div style="display: flex; align-items: center; justify-content: center; gap: 20px; margin: 20px 0;">
          <label class="toggle-switch">
            <input type="checkbox" id="voice-assistant-toggle" onchange="toggleVoiceAssistant()">
            <span class="toggle-slider"></span>
          </label>
          <span id="voice-assistant-status" style="font-size: 18px; font-weight: bold; color: goldenrod;">
            Voice Assistant: Disabled
          </span>
        </div>
        
        <!-- Voice Command Notification -->
        <div id="voice-command-notification" style="display: none; background-color: #2a4a2a; padding: 15px; border-radius: 5px; margin: 15px 0; border: 2px solid #4a7c59;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <div class="listening-indicator"></div>
            <span id="notification-text" style="color: #90ee90; font-weight: bold;">Listening for commands...</span>
          </div>
        </div>
        
        <!-- Available Commands Info -->
        <div style="background-color: #2a2a2a; padding: 15px; border-radius: 5px; margin: 15px 0;">
          <h4 style="color: goldenrod; margin-bottom: 10px;">Available Voice Commands:</h4>
          <ul style="text-align: left; color: white; line-height: 1.8;">
            <li>"Start recording" - Begin audio transcription</li>
            <li>"Stop recording" - End audio transcription</li>
            <li>"Clear transcript" - Clear current transcript</li>
            <li>"Generate summary" or "Summarize" - Create AI summary</li>
            <li>"Export as text" or "Export as JSON" - Export transcript</li>
            <li>"Show sessions" - Display session list</li>
            <li>"Help" - Show available commands</li>
          </ul>
        </div>
        
        <!-- Command History -->
        <div id="command-history" style="background-color: #2a2a2a; padding: 15px; border-radius: 5px; margin: 15px 0; display: none;">
          <h4 style="color: goldenrod; margin-bottom: 10px;">Recent Commands:</h4>
          <div id="command-history-list" style="text-align: left; color: #ccc; max-height: 150px; overflow-y: auto;">
            <!-- Command history will be added here -->
          </div>
        </div>
      </div>

      <!-- Voice Training Section -->
      <div class="section voice-training"  id="voice-training-section">
        <h3>üéØ Voice Training</h3>
        <p>Train the app to better recognize your voice for improved accuracy</p>
        <div class="form-group">
          <label>Your Name:</label>
          <input type="text" id="training-user-name" placeholder="Enter your name" />
        </div>
        <div class="form-group">
          <label>Training Text (read this aloud):</label>
          <textarea id="training-text" rows="4" onchange="updateTrainingDuration()">The quick brown fox jumps over the lazy dog. This sentence contains every letter of the alphabet and is perfect for voice training. Please read this clearly and at a normal pace.</textarea>
        </div>
        <div style="text-align: center; margin: 20px 0;">
          <p id="training-duration-info">Estimated training time: <span id="training-duration">15</span> seconds</p>
          <button class="button" onclick="startVoiceTraining()">Start Voice Training</button>
        </div>
        <div class="progress-bar" id="training-progress" style="display: none;">
          <div class="progress-fill" id="training-progress-fill"></div>
          <div style="text-align: center; margin-top: 5px;">
            <span id="training-status">Preparing training...</span>
          </div>
        </div>
      </div>

      <!-- Export & Session Management -->
      <div class="section" id="export-section">
        <h3>üíæ Export & Session Management</h3>
        <div style="margin: 15px 0;">
          <button class="button" onclick="exportCurrentTranscript('txt')" id="export-current-txt">Export Current as TXT</button>
          <button class="button" onclick="exportCurrentTranscript('json')" id="export-current-json">Export Current as JSON</button>
          <button class="button" onclick="generateSummary()" id="generate-summary-btn">Generate Summary</button>
        </div>
        <div class="sessions-list" id="sessions-list">
          <div>No sessions yet. Start recording or upload a file to create your first session.</div>
        </div>
      </div>

    </section>

    <footer>
      <div class="footer">
        <div class="w-container">
          <div class="w-row">
            <div class="w-col w-col-4">
              <h3>About</h3>
              <div></div>
              <div>Has AI</div>
              <div>AI Speech-to-text App</div>
              <div>Website made with Python, Flask & Html</div>
              <div>AI Projects for all</div>
              <div>
                Welcome to Has AI, a sub-brand of Akhtar Hasan Software Solutions
              </div>
            </div>
            <div class="w-col w-col-4">
              <h3>Useful Links</h3>
              <div class="footer-link-row">
                <li><a href="#recording-section" target="_blank" class="footer-link">Recording Section</a></li>
                <li><a href="#file-upload-section" target="_blank" class="footer-link">File Upload Section</a></li>
              </div>
              <div class="footer-link-row">
                <li><a href="#ai-summary-section" target="_blank" class="footer-link">AI Summary Section</a></li>
                <li><a href="#voice-commands-section" target="_blank" class="footer-link">Voice Command Section</a></li>
              </div>
              <div class="footer-link-row">
                <li><a href="#voice-training-section" target="_blank" class="footer-link">Voice Training Section</a></li>
                <li><a href="#export-section" target="_blank" class="footer-link">Export Section</a></li>
              </div>
            </div>
            <div class="f-col">
              <h3>Socials</h3>
              <div>
                <img
                  src="https://assets-global.website-files.com/5739f5a49fbb0b705633b84e/5739f5a59fbb0b705633b875_social-18.svg"
                  width="20"
                  alt=""
                  class="info-icon"
                />
                <a href="https://twitter.com/PythonPrgrmrYT" class="footer-link with-icon"
                  >X (Twitter)</a
                >
              </div>
              <div>
                <img
                  src="https://cdn.prod.website-files.com/662001a30f75ce6c5c72acf8/662001a30f75ce6c5c72ad80_social-16.svg"
                  width="20"
                  alt=""
                  class="info-icon"
                />
                <a
                  href="https://www.youtube.com/channel/UCIkg7kLDRl90fHEb2tFYRwg"
                  class="footer-link with-icon"
                  >YouTube</a
                >
              </div>
              <div>
                <img
                  src="https://cdn.prod.website-files.com/662001a30f75ce6c5c72acf8/662001a30f75ce6c5c72ad88_social-33.svg"
                  width="20"
                  alt=""
                  class="info-icon"
                />
                <a
                  href="https://github.com/AkhHas2005"
                  class="footer-link with-icon"
                  >GitHub</a
                >
              </div>
              <div>
                <img
                  src="https://cdn.prod.website-files.com/662001a30f75ce6c5c72acf8/662001a30f75ce6c5c72ad6b_social-07.svg"
                  width="20"
                  alt=""
                  class="info-icon"
                />
                <a href="https://www.instagram.com/pythonprogrammeryt/" 
                class="footer-link with-icon"
                  >Instagram</a
                >
              </div>
            </div>
          </div>
        </div>
      </div>
      <hr />
      <h1>&copy; Akhtar Hasan (aka Python Programmer) 2025</h1>
    </footer>

    <script>
      let isRecording = false;
      let currentSessionId = null;
      let currentTranscript = "";

      // Recording functions
      function toggleRecording() {
        if (isRecording) {
          stopRecording();
        } else {
          startRecording();
        }
      }

      function startRecording() {
        fetch('/api/start-recording', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            isRecording = true;
            currentSessionId = data.session_id;
            updateRecordingUI();
            startTranscriptPolling();
          } else {
            alert('Error starting recording: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error starting recording');
        });
      }

      function stopRecording() {
        fetch('/api/stop-recording', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ include_summary: true })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            isRecording = false;
            currentTranscript = data.transcript;
            updateRecordingUI();
            stopTranscriptPolling();
            
            if (data.summary) {
              showAISummary(data.summary);
            }
            
            loadSessions();
          } else {
            alert('Error stopping recording: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error stopping recording');
        });
      }

      function updateRecordingUI() {
        const button = document.getElementById('record-button');
        const status = document.getElementById('recording-status');
        const statusText = document.getElementById('recording-status-text');

        if (isRecording) {
          button.textContent = 'Stop Recording';
          button.classList.add('recording');
          status.classList.add('status-recording');
          status.classList.remove('status-ready');
          statusText.textContent = 'Recording...';
        } else {
          button.textContent = 'Start Recording';
          button.classList.remove('recording');
          status.classList.add('status-ready');
          status.classList.remove('status-recording');
          statusText.textContent = 'Ready to record';
        }
      }

      // Transcript polling
      let transcriptInterval;

      function startTranscriptPolling() {
        transcriptInterval = setInterval(() => {
          fetch('/api/get-transcript')
            .then(response => response.json())
            .then(data => {
              if (data.transcript) {
                document.getElementById('live-transcript').textContent = data.transcript;
                currentTranscript = data.transcript;
              }
            })
            .catch(error => console.error('Error:', error));
        }, 1000);
      }

      function stopTranscriptPolling() {
        if (transcriptInterval) {
          clearInterval(transcriptInterval);
        }
      }

      // Voice commands
      function processVoiceCommand() {
        const commandInput = document.getElementById('voice-command-input');
        const command = commandInput.value.trim();
        
        if (!command) {
          alert('Please enter a command');
          return;
        }

        fetch('/api/voice-command', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command: command })
        })
        .then(response => response.json())
        .then(data => {
          const responseDiv = document.getElementById('voice-command-response');
          responseDiv.innerHTML = data.response || data.error;
          
          if (data.summary) {
            showAISummary(data.summary);
          }
          
          commandInput.value = '';
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('voice-command-response').textContent = 'Error processing command';
        });
      }

      // Voice training
      function startVoiceTraining() {
        const userName = document.getElementById('training-user-name').value.trim();
        const trainingText = document.getElementById('training-text').value;
        
        if (!userName) {
          alert('Please enter your name');
          return;
        }

        const progressBar = document.getElementById('training-progress');
        const progressFill = document.getElementById('training-progress-fill');
        const statusText = document.getElementById('training-status');
        
        // Calculate actual duration based on text length
        const wordCount = trainingText.trim().split(/\s+/).length;
        const actualDuration = Math.max(10, Math.ceil(wordCount / 2)); // seconds
        const progressInterval = 100; // Update every 100ms
        const totalSteps = (actualDuration * 1000) / progressInterval;
        
        progressBar.style.display = 'block';
        progressFill.style.width = '0%';
        statusText.textContent = 'Starting voice training...';

        // Start the training request
        const startTime = Date.now();
        
        fetch('/api/train-voice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            user_name: userName, 
            training_text: trainingText,
            duration: actualDuration
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Progress will be handled by the interval below
            console.log('Training completed on server');
          } else {
            alert('Error training voice: ' + data.error);
            progressBar.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error training voice');
          progressBar.style.display = 'none';
        });

        // Progress animation that matches actual duration
        let step = 0;
        const interval = setInterval(() => {
          step++;
          const progress = Math.min((step / totalSteps) * 100, 100);
          progressFill.style.width = progress + '%';
          
          // Update status based on progress
          if (progress <= 25) {
            statusText.textContent = 'Recording voice samples...';
          } else if (progress <= 50) {
            statusText.textContent = 'Analyzing voice patterns...';
          } else if (progress <= 75) {
            statusText.textContent = 'Training voice model...';
          } else if (progress < 100) {
            statusText.textContent = 'Finalizing voice profile...';
          } else {
            statusText.textContent = 'Training completed successfully!';
          }
          
          if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
              alert(`Voice training completed for ${userName}!`);
              progressBar.style.display = 'none';
            }, 1000);
          }
        }, progressInterval);
      }

      // Add this function to calculate training duration
      function updateTrainingDuration() {
        const trainingText = document.getElementById('training-text').value;
        const wordCount = trainingText.trim().split(/\s+/).length;
        const estimatedDuration = Math.max(10, Math.ceil(wordCount / 2)); // 1 second per 2 words, minimum 10 seconds
        document.getElementById('training-duration').textContent = estimatedDuration;
      }

      // Utility functions
      function clearTranscript() {
        if (confirm('Are you sure you want to clear the transcript?')) {
          // Clear all transcript-related variables
          currentTranscript = "";
          window.currentUploadTranscript = "";
          window.currentUploadSummary = "";
          window.currentSessionId = null;
          
          // Clear UI elements
          document.getElementById('live-transcript').textContent = 'Transcript cleared. Start recording to begin again...';
          
          // Clear upload preview
          const previewSection = document.getElementById('upload-preview');
          if (previewSection) {
            previewSection.style.display = 'none';
          }
          
          // Clear AI summary
          const summaryContent = document.querySelector('.ai-summary');
          if (summaryContent) {
            summaryContent.innerHTML = 'No AI summary available. Upload an audio file or start recording to generate a summary.';
          }
          
          // Reset form
          const uploadForm = document.getElementById('upload-form');
          if (uploadForm) {
            uploadForm.reset();
          }
          
          console.log('Transcript cleared successfully');
        }
      }

      function showAISummary(summary) {
        // Find the existing AI summary section
        let summaryContent = document.querySelector('.ai-summary');
        
        if (!summaryContent) {
          // If no summary section exists, create one
          const summarySection = document.createElement('div');
          summarySection.className = 'section';
          summarySection.innerHTML = `
            <h3>ü§ñ AI Summary</h3>
            <div class="ai-summary" id="ai-summary-content"></div>
          `;
          
          // Insert after the file upload section
          const uploadSection = document.querySelector('#file-upload-section').parentElement;
          uploadSection.insertAdjacentElement('afterend', summarySection);
          
          summaryContent = summarySection.querySelector('.ai-summary');
        }
        
        // Update the summary content
        summaryContent.innerHTML = summary.replace(/\n/g, '<br>');
        
        // Scroll to the summary section
        summaryContent.scrollIntoView({ behavior: 'smooth' });
      }

      function loadSessions() {
        fetch('/api/get-sessions')
          .then(response => response.json())
          .then(data => {
            const sessionsList = document.getElementById('sessions-list');
            if (data.sessions && data.sessions.length > 0) {
              sessionsList.innerHTML = data.sessions.map(session => `
                <div class="session-item">
                  <div>
                    <strong>${session.id}</strong><br>
                    <small>${session.type} - ${new Date(session.timestamp).toLocaleString()}</small>
                    ${session.filename ? `<br><small>File: ${session.filename}</small>` : ''}
                  </div>
                  <div>
                    <button class="button" onclick="viewSession('${session.id}')">View</button>
                    <button class="button" onclick="exportSession('${session.id}', 'txt')">Export TXT</button>
                    <button class="button" onclick="exportSession('${session.id}', 'json')">Export JSON</button>
                    <button class="button" onclick="deleteSession('${session.id}')">Delete</button>
                  </div>
                </div>
              `).join('');
            } else {
              sessionsList.innerHTML = '<div>No sessions yet. Start recording or upload a file to create your first session.</div>';
            }
          })
          .catch(error => console.error('Error:', error));
      }

      function viewSession(sessionId) {
        fetch(`/api/get-session/${sessionId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const session = data.session;
              alert(`Session: ${sessionId}\n\nTranscript (${session.transcript.length} characters):\n${session.transcript.substring(0, 300)}${session.transcript.length > 300 ? '...' : ''}\n\n${session.summary ? 'Summary available: Yes' : 'Summary: No'}`);
            } else {
              alert('Error loading session: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error loading session');
          });
      }

      function exportSession(sessionId, format) {
        console.log(`Exporting session ${sessionId} as ${format}`);
        
        // Method 1: Try direct URL approach
        const exportUrl = `/api/export-transcript/${sessionId}/${format}`;
        
        // Create a temporary link and trigger download
        const link = document.createElement('a');
        link.href = exportUrl;
        link.download = `transcript_${sessionId}.${format}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Alternative method with fetch for better error handling
        /*
        fetch('/api/export-transcript', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            session_id: sessionId,
            format: format
          })
        })
        .then(response => {
          if (response.ok) {
            return response.blob();
          } else {
            return response.json().then(err => Promise.reject(err));
          }
        })
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `transcript_${sessionId}.${format}`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
        })
        .catch(error => {
          console.error('Export error:', error);
          alert('Error exporting transcript: ' + (error.error || error.message || 'Unknown error'));
        });
        */
      }

      function exportCurrentTranscript(format) {
        if (!currentTranscript || currentTranscript.trim() === '') {
          alert('No transcript available to export');
          return;
        }
        
        // Create a temporary session for current transcript
        const tempSessionId = `temp_${Date.now()}`;
        
        // Use the direct export approach
        fetch('/api/export-transcript', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            session_id: tempSessionId,
            format: format,
            transcript: currentTranscript,
            summary: document.querySelector('.ai-summary')?.textContent || '',
            temporary: true
          })
        })
        .then(response => {
          if (response.ok) {
            return response.blob();
          } else {
            return response.json().then(err => Promise.reject(err));
          }
        })
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `current_transcript_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.${format}`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
        })
        .catch(error => {
          console.error('Export error:', error);
          alert('Error exporting transcript: ' + (error.error || error.message || 'Unknown error'));
        });
      }

      function generateSummary() {
        if (!currentTranscript && !window.currentUploadTranscript) {
          alert('No transcript available to summarize. Please record audio or upload a file first.');
          return;
        }
        
        const transcript = currentTranscript || window.currentUploadTranscript;
        
        fetch('/api/voice-command', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command: 'summarize transcript' })
        })
        .then(response => response.json())
        .then(data => {
          if (data.summary) {
            showAISummary(data.summary);
          } else if (data.response) {
            showAISummary(data.response);
          } else {
            alert('Error generating summary: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Error generating summary');
        });
      }

      function deleteSession(sessionId) {
        if (confirm(`Are you sure you want to delete session ${sessionId}?`)) {
          fetch(`/api/delete-session/${sessionId}`, {
            method: 'DELETE'
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Session deleted successfully');
              loadSessions();
            } else {
              alert('Error deleting session: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error deleting session');
          });
        }
      }
      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
        updateTrainingDuration();
        loadSessions();
        updateRecordingUI();
      });

      // Handle form submission for file upload with preview
      document.getElementById('upload-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this); // Use 'this' to get all form data including CSRF token
        const previewSection = document.getElementById('upload-preview');
        const previewDiv = document.getElementById('upload-transcript-preview');
        
        console.log('Form submission started');
        
        // Show preview section
        previewSection.style.display = 'block';
        previewDiv.textContent = 'Processing uploaded file...';
        
        console.log('Sending request to /api/upload-audio');
        
        fetch('/api/upload-audio', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          console.log('Response status:', response.status);
          console.log('Response headers:', response.headers);
          
          // Check if response is ok before parsing JSON
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          // Check content type
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Response is not JSON');
          }
          
          return response.json();
        })
        .then(data => {
          console.log('Response data:', data);
          
          if (data.success) {
            // Show transcript preview (first 200 characters)
            const fullTranscript = data.transcript;
            const preview = fullTranscript.length > 200 ? 
              fullTranscript.substring(0, 200) + '...' : fullTranscript;
            
            previewDiv.innerHTML = `
              <strong>Preview:</strong><br>
              <div style="background-color: #2a2a3a; padding: 10px; border-radius: 5px; margin: 10px 0;">
                ${preview}
              </div>
              <small><strong>File:</strong> ${data.filename} | <strong>Length:</strong> ${fullTranscript.length} characters</small>
            `;
            
            // Store full transcript for later use
            window.currentUploadTranscript = fullTranscript;
            window.currentUploadSummary = data.summary;
            window.currentSessionId = data.session_id;
            
            if (fullTranscript.length > 200) {
              document.getElementById('upload-full-transcript').style.display = 'block';
            }
            
            // Show AI summary if available
            if (data.summary) {
              showAISummary(data.summary);
            }
            
            // Refresh sessions list
            loadSessions();
            
            // Show success message
            alert('File uploaded and transcribed successfully!');
            
          } else {
            previewDiv.innerHTML = `<strong>Error:</strong> ${data.error}`;
            console.error('Upload failed:', data.error);
          }
        })
        .catch(error => {
          console.error('Fetch error details:', error);
          previewDiv.innerHTML = `
            <strong>Network Error:</strong> ${error.message}<br>
            <small>Check the browser console for more details.</small>
          `;
        });
      });

      function showFullTranscript() {
        if (window.currentUploadTranscript) {
          const previewDiv = document.getElementById('upload-transcript-preview');
          previewDiv.innerHTML = `
            <strong>Full Transcript:</strong><br>
            <div style="background-color: #2a2a3a; padding: 10px; border-radius: 5px; margin: 10px 0; max-height: 300px; overflow-y: auto;">
              ${window.currentUploadTranscript}
            </div>
            <small><strong>Total Length:</strong> ${window.currentUploadTranscript.length} characters</small>
            <br><button class="button" onclick="showPreviewTranscript()">Show Preview Only</button>
          `;
        }
      }

      function showPreviewTranscript() {
        if (window.currentUploadTranscript) {
          const preview = window.currentUploadTranscript.length > 200 ? 
            window.currentUploadTranscript.substring(0, 200) + '...' : window.currentUploadTranscript;
          
          const previewDiv = document.getElementById('upload-transcript-preview');
          previewDiv.innerHTML = `
            <strong>Preview:</strong><br>
            <div style="background-color: #2a2a3a; padding: 10px; border-radius: 5px; margin: 10px 0;">
              ${preview}
            </div>
            <small><strong>Length:</strong> ${window.currentUploadTranscript.length} characters</small>
          `;
          
          if (window.currentUploadTranscript.length > 200) {
            document.getElementById('upload-full-transcript').style.display = 'block';
          }
        }
      }

      // Hoverable header functionality
      document.addEventListener('DOMContentLoaded', function() {
        const header = document.querySelector('header');
        const hoverZoneHeight = 50; // pixels from top to trigger header

        // Show header when mouse is near top
        document.addEventListener('mousemove', function(e) {
          if (e.clientY <= hoverZoneHeight) {
            header.classList.add('header-hover');
          } else if (!header.matches(':hover')) {
            header.classList.remove('header-hover');
          }
        });

        // Keep header visible while hovering over it
        header.addEventListener('mouseenter', function() {
          header.classList.add('header-hover');
        });

        header.addEventListener('mouseleave', function() {
          header.classList.remove('header-hover');
        });
      });

      // Voice Assistant Variables
      let voiceAssistantEnabled = false;
      let voiceAssistantRecognition = null;
      let commandHistory = [];

      // Initialize Voice Assistant
      function initializeVoiceAssistant() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
          alert('Voice commands are not supported in this browser. Please use Chrome, Edge, or Safari.');
          return false;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        voiceAssistantRecognition = new SpeechRecognition();
        
        voiceAssistantRecognition.continuous = true;
        voiceAssistantRecognition.interimResults = false;
        voiceAssistantRecognition.lang = 'en-US';
        voiceAssistantRecognition.maxAlternatives = 1;

        voiceAssistantRecognition.onstart = function() {
          console.log('Voice assistant started listening');
          updateVoiceNotification('Listening for commands...', true);
        };

        voiceAssistantRecognition.onresult = function(event) {
          const last = event.results.length - 1;
          const command = event.results[last][0].transcript.trim().toLowerCase();
          
          console.log('Voice command detected:', command);
          updateVoiceNotification(`Command: "${command}"`, true);
          
          // Process the voice command
          processDetectedVoiceCommand(command);
        };

        voiceAssistantRecognition.onerror = function(event) {
          console.error('Voice recognition error:', event.error);
          if (event.error === 'no-speech') {
            // Silently restart - no speech detected
            if (voiceAssistantEnabled) {
              setTimeout(() => {
                try {
                  voiceAssistantRecognition.start();
                } catch (e) {
                  console.log('Recognition already started');
                }
              }, 100);
            }
          } else {
            updateVoiceNotification(`Error: ${event.error}`, true);
            setTimeout(() => {
              if (voiceAssistantEnabled) {
                updateVoiceNotification('Listening for commands...', true);
              }
            }, 2000);
          }
        };

        voiceAssistantRecognition.onend = function() {
          console.log('Voice recognition ended');
          // Restart if still enabled
          if (voiceAssistantEnabled) {
            try {
              voiceAssistantRecognition.start();
            } catch (e) {
              console.log('Recognition restart failed:', e);
            }
          }
        };

        return true;
      }

      // Toggle Voice Assistant
      function toggleVoiceAssistant() {
        const toggle = document.getElementById('voice-assistant-toggle');
        const statusText = document.getElementById('voice-assistant-status');
        
        voiceAssistantEnabled = toggle.checked;

        if (voiceAssistantEnabled) {
          // Initialize if not already done
          if (!voiceAssistantRecognition) {
            if (!initializeVoiceAssistant()) {
              toggle.checked = false;
              return;
            }
          }

          // Start listening
          try {
            voiceAssistantRecognition.start();
            statusText.textContent = 'Voice Assistant: Enabled';
            statusText.style.color = '#28a745';
            showVoiceNotification('Voice commands enabled - Ready to listen!');
            
            // Show command history
            document.getElementById('command-history').style.display = 'block';
          } catch (e) {
            console.error('Error starting voice assistant:', e);
            toggle.checked = false;
            voiceAssistantEnabled = false;
            statusText.textContent = 'Voice Assistant: Error';
            statusText.style.color = '#dc3545';
          }
        } else {
          // Stop listening
          if (voiceAssistantRecognition) {
            voiceAssistantRecognition.stop();
          }
          statusText.textContent = 'Voice Assistant: Disabled';
          statusText.style.color = '#666';
          hideVoiceNotification();
          
          // Optionally hide command history when disabled
          setTimeout(() => {
            document.getElementById('command-history').style.display = 'none';
          }, 300);
        }
      }

      // Update Voice Notification
      function updateVoiceNotification(message, show) {
        const notification = document.getElementById('voice-command-notification');
        const notificationText = document.getElementById('notification-text');
        
        notificationText.textContent = message;
        
        if (show && !notification.style.display || notification.style.display === 'none') {
          notification.style.display = 'block';
          notification.classList.remove('voice-notification-hide');
          notification.classList.add('voice-notification-show');
        }
      }

      // Show Voice Notification
      function showVoiceNotification(message) {
        updateVoiceNotification(message, true);
      }

      // Hide Voice Notification
      function hideVoiceNotification() {
        const notification = document.getElementById('voice-command-notification');
        notification.classList.remove('voice-notification-show');
        notification.classList.add('voice-notification-hide');
        
        setTimeout(() => {
          notification.style.display = 'none';
        }, 300);
      }

      // Process Detected Voice Command
      function processDetectedVoiceCommand(command) {
        console.log('Processing voice command:', command);
        
        let action = null;
        let success = false;
        let response = '';

        // Command matching
        if (command.includes('start recording') || command.includes('begin recording')) {
          action = 'start_recording';
          if (!isRecording) {
            startRecording();
            response = 'Starting recording';
            success = true;
          } else {
            response = 'Already recording';
          }
        } 
        else if (command.includes('stop recording') || command.includes('end recording')) {
          action = 'stop_recording';
          if (isRecording) {
            stopRecording();
            response = 'Stopping recording';
            success = true;
          } else {
            response = 'Not currently recording';
          }
        } 
        else if (command.includes('clear transcript') || command.includes('delete transcript')) {
          action = 'clear_transcript';
          clearTranscript();
          response = 'Transcript cleared';
          success = true;
        } 
        else if (command.includes('generate summary') || command.includes('summarize') || command.includes('create summary')) {
          action = 'generate_summary';
          generateSummary();
          response = 'Generating summary';
          success = true;
        } 
        else if (command.includes('export as text') || command.includes('export txt')) {
          action = 'export_txt';
          exportCurrentTranscript('txt');
          response = 'Exporting as text file';
          success = true;
        } 
        else if (command.includes('export as json') || command.includes('export json')) {
          action = 'export_json';
          exportCurrentTranscript('json');
          response = 'Exporting as JSON file';
          success = true;
        } 
        else if (command.includes('show sessions') || command.includes('view sessions')) {
          action = 'show_sessions';
          document.getElementById('export-section').scrollIntoView({ behavior: 'smooth' });
          response = 'Showing sessions';
          success = true;
        } 
        else if (command.includes('help') || command.includes('what can you do')) {
          action = 'help';
          response = 'Available commands shown below';
          document.getElementById('voice-commands-section').scrollIntoView({ behavior: 'smooth' });
          success = true;
        }
        else {
          action = 'unknown';
          response = 'Command not recognized. Say "help" for available commands.';
        }

        // Update notification
        updateVoiceNotification(response, true);
        
        // Add to command history
        addCommandToHistory(command, response, success);
        
        // Clear notification after 3 seconds
        setTimeout(() => {
          if (voiceAssistantEnabled) {
            updateVoiceNotification('Listening for commands...', true);
          }
        }, 3000);
      }

      // Add Command to History
      function addCommandToHistory(command, response, success) {
        const timestamp = new Date().toLocaleTimeString();
        const historyItem = {
          command: command,
          response: response,
          success: success,
          timestamp: timestamp
        };
        
        commandHistory.unshift(historyItem);
        
        // Keep only last 10 commands
        if (commandHistory.length > 10) {
          commandHistory.pop();
        }
        
        // Update UI
        updateCommandHistoryUI();
      }

      // Update Command History UI
      function updateCommandHistoryUI() {
        const historyList = document.getElementById('command-history-list');
        
        if (commandHistory.length === 0) {
          historyList.innerHTML = '<div style="color: #888; padding: 10px;">No commands yet</div>';
          return;
        }
        
        historyList.innerHTML = commandHistory.map(item => `
          <div class="command-history-item ${item.success ? 'command-success' : 'command-error'}">
            <strong>"${item.command}"</strong>
            <span class="command-timestamp">${item.timestamp}</span>
            <br>
            <small style="color: #aaa;">${item.response}</small>
          </div>
        `).join('');
      }

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
        updateTrainingDuration();
        loadSessions();
        updateRecordingUI();
        
        // Initialize voice assistant (but don't start it)
        initializeVoiceAssistant();
      });
    </script>
  </body>
</html>
